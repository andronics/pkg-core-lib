#!/usr/bin/env zsh
# Convert YAML skill definition to markdown skill file

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: yaml-to-skill <yaml-file> [output-file]" >&2
    exit 1
fi

yaml_file="$1"
output_file="${2:-}"

if [[ ! -f "$yaml_file" ]]; then
    echo "Error: YAML file not found: $yaml_file" >&2
    exit 1
fi

# Extract fields using yq
name=$(yq -r '.name' "$yaml_file")
description=$(yq -r '.description' "$yaml_file")
tools=$(yq -r '.skill.scope.tools[]?' "$yaml_file" 2>/dev/null | tr '\n' ',' | sed 's/,$//')
model=$(yq -r '.skill.preferences.model // empty' "$yaml_file")
instructions=$(yq -r '.skill.instructions' "$yaml_file")
keywords=$(yq -r '.skill.triggers.keywords[]?' "$yaml_file" 2>/dev/null | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
context_files=$(yq -r '.skill.scope.context_files[]?' "$yaml_file" 2>/dev/null)
examples=$(yq -r '.skill.examples[]?' "$yaml_file" 2>/dev/null)
limitations=$(yq -r '.skill.limitations // empty' "$yaml_file")

# Generate output file path if not provided
if [[ -z "$output_file" ]]; then
    output_file="${name}.md"
fi

# Generate markdown skill file
cat > "$output_file" <<EOF
---
name: ${name}
description: ${description}
EOF

if [[ -n "$tools" ]]; then
    echo "tools: ${tools}" >> "$output_file"
fi

if [[ -n "$model" ]]; then
    echo "model: ${model}" >> "$output_file"
fi

cat >> "$output_file" <<EOF
---

# ${name}

${instructions}

EOF

if [[ -n "$keywords" ]]; then
    cat >> "$output_file" <<EOF
## Activation
Keywords: ${keywords}

EOF
fi

if [[ -n "$context_files" ]]; then
    cat >> "$output_file" <<EOF
## Required Context Files

This skill requires access to the following files:

EOF
    echo "$context_files" | while IFS= read -r file; do
        if [[ -n "$file" ]]; then
            echo "- \`${file}\`" >> "$output_file"
        fi
    done
    echo "" >> "$output_file"
    echo "Before activating this skill, ensure these files exist and are current." >> "$output_file"
    echo "" >> "$output_file"
fi

if [[ -n "$examples" ]]; then
    cat >> "$output_file" <<EOF
## Examples

EOF
    echo "$examples" | while IFS= read -r example; do
        if [[ -n "$example" ]]; then
            echo "${example}" >> "$output_file"
            echo "" >> "$output_file"
        fi
    done
fi

if [[ -n "$limitations" ]]; then
    cat >> "$output_file" <<EOF
## Limitations

${limitations}
EOF
fi

echo "Skill file generated: $output_file"
