#!/usr/bin/env zsh

# _acpi - ACPI Event and Power Management System
# Part of the dotfiles library v2.0
# Version: 2.1.0
#
# Usage:
#   source "$(which _acpi)"
#
# Provides:
#   - ACPI event listening and handling
#   - Battery status and monitoring
#   - Thermal zone monitoring
#   - AC adapter status detection
#   - Power state management
#   - Event filtering and callbacks
#   - Integration with infrastructure layer (v2.0)
#
# Dependencies:
#   Required:
#     - _common v2.0: Core utilities
#     - acpid: ACPI daemon (system service)
#     - nc/netcat: Socket communication
#   Optional (gracefully degraded):
#     - _log v2.0: Structured logging
#     - _events v2.0: Event system
#     - _cache v2.0: Performance caching
#     - _lifecycle v2.0: Cleanup management
#     - _config v2.0: Configuration management

# ------------------------------
# Source Guard
# ------------------------------

[[ -n "${ACPI_LOADED:-}" ]] && return 0
declare -g ACPI_LOADED=1

# ------------------------------
# Version
# ------------------------------

declare -r ACPI_VERSION="2.1.0"

# ------------------------------
# Dependency Loading
# ------------------------------

# Load foundation (required) from same directory
_ACPI_DIR="${${(%):-%x}:A:h}"
if ! source "$_ACPI_DIR/_common" 2>/dev/null; then
    # Fallback: try which (may find v1.0 in extensions)
    if ! source "$(which _common)" 2>/dev/null; then
        echo "[ERROR] _acpi requires _common v2.0 - cannot load" >&2
        return 1
    fi
fi
unset _ACPI_DIR

# Load infrastructure (optional with fallbacks) from same directory
_ACPI_DIR="${${(%):-%x}:A:h}"

if ! source "$_ACPI_DIR/_log" 2>/dev/null; then
    log-info() { echo "[INFO] $*"; }
    log-error() { echo "[ERROR] $*" >&2; }
    log-warn() { echo "[WARN] $*" >&2; }
    log-warning() { echo "[WARN] $*" >&2; }
    log-debug() { [[ "${ACPI_DEBUG:-false}" == "true" ]] && echo "[DEBUG] $*" >&2 || true; }
    log-trace() { [[ "${ACPI_DEBUG:-false}" == "true" ]] && echo "[TRACE] $*" >&2 || true; }
    log-success() { echo "[SUCCESS] $*"; }
fi

if source "$_ACPI_DIR/_events" 2>/dev/null; then
    declare -g ACPI_EVENTS_AVAILABLE=true
else
    declare -g ACPI_EVENTS_AVAILABLE=false
fi

if source "$_ACPI_DIR/_cache" 2>/dev/null; then
    declare -g ACPI_CACHE_AVAILABLE=true
else
    declare -g ACPI_CACHE_AVAILABLE=false
fi

if source "$_ACPI_DIR/_lifecycle" 2>/dev/null; then
    declare -g ACPI_LIFECYCLE_AVAILABLE=true
else
    declare -g ACPI_LIFECYCLE_AVAILABLE=false
fi

if source "$_ACPI_DIR/_config" 2>/dev/null; then
    declare -g ACPI_CONFIG_AVAILABLE=true
else
    declare -g ACPI_CONFIG_AVAILABLE=false
fi

unset _ACPI_DIR

# ------------------------------
# Configuration
# ------------------------------

# Paths (XDG-compliant via _common)
declare -g ACPI_CACHE_DIR="$(common-lib-cache-dir)/acpi"
declare -g ACPI_STATE_DIR="$(common-lib-state-dir)/acpi"
declare -g ACPI_CONFIG_DIR="$(common-lib-config-dir)/acpi"

# ACPI system paths
declare -g ACPI_SOCKET="${ACPI_SOCKET:-/var/run/acpid.socket}"
declare -g ACPI_SYSFS_PATH="${ACPI_SYSFS_PATH:-/sys/class}"
declare -g ACPI_PROC_PATH="${ACPI_PROC_PATH:-/proc/acpi}"

# Monitoring thresholds
declare -g ACPI_BATTERY_LOW_THRESHOLD="${ACPI_BATTERY_LOW_THRESHOLD:-20}"
declare -g ACPI_BATTERY_CRITICAL_THRESHOLD="${ACPI_BATTERY_CRITICAL_THRESHOLD:-10}"
declare -g ACPI_THERMAL_WARNING_THRESHOLD="${ACPI_THERMAL_WARNING_THRESHOLD:-80000}"
declare -g ACPI_THERMAL_CRITICAL_THRESHOLD="${ACPI_THERMAL_CRITICAL_THRESHOLD:-95000}"

# Event configuration
declare -g ACPI_EVENT_PREFIX="${ACPI_EVENT_PREFIX:-acpi}"
declare -g ACPI_EMIT_EVENTS="${ACPI_EMIT_EVENTS:-true}"
declare -g ACPI_AUTO_CLEANUP="${ACPI_AUTO_CLEANUP:-true}"

# Behavior configuration
declare -g ACPI_DEBUG="${ACPI_DEBUG:-false}"
declare -g ACPI_VERBOSE="${ACPI_VERBOSE:-false}"
declare -g ACPI_DRY_RUN="${ACPI_DRY_RUN:-false}"

# Cache TTL configuration
declare -g ACPI_CACHE_BATTERY_TTL="${ACPI_CACHE_BATTERY_TTL:-5}"      # 5 seconds
declare -g ACPI_CACHE_THERMAL_TTL="${ACPI_CACHE_THERMAL_TTL:-2}"      # 2 seconds
declare -g ACPI_CACHE_AC_TTL="${ACPI_CACHE_AC_TTL:-10}"               # 10 seconds

# ------------------------------
# Global State
# ------------------------------

# Listener state
declare -g ACPI_LISTENER_PID=""
declare -g ACPI_LISTENER_ACTIVE="false"

# Event callbacks (event_pattern -> callback_function)
declare -g -A _ACPI_EVENT_CALLBACKS=()

# Battery/thermal/AC status tracking
declare -g -A _ACPI_BATTERY_STATUS=()
declare -g -A _ACPI_THERMAL_STATUS=()
declare -g -A _ACPI_AC_STATUS=()

# Initialization flag
declare -g _ACPI_INITIALIZED="false"

# Event names for integration
declare -r ACPI_EVENT_RAW="acpi.raw"
declare -r ACPI_EVENT_BATTERY="acpi.battery"
declare -r ACPI_EVENT_BATTERY_CHANGE="acpi.battery.change"
declare -r ACPI_EVENT_AC="acpi.ac"
declare -r ACPI_EVENT_AC_CONNECT="acpi.ac.connect"
declare -r ACPI_EVENT_AC_DISCONNECT="acpi.ac.disconnect"
declare -r ACPI_EVENT_THERMAL="acpi.thermal"
declare -r ACPI_EVENT_LID="acpi.lid"
declare -r ACPI_EVENT_LID_OPEN="acpi.lid.open"
declare -r ACPI_EVENT_LID_CLOSE="acpi.lid.close"
declare -r ACPI_EVENT_BUTTON="acpi.button"
declare -r ACPI_EVENT_LOW_BATTERY="acpi.battery.low"
declare -r ACPI_EVENT_CRITICAL_BATTERY="acpi.battery.critical"
declare -r ACPI_EVENT_THERMAL_WARNING="acpi.thermal.warning"
declare -r ACPI_EVENT_THERMAL_CRITICAL="acpi.thermal.critical"

# ------------------------------
# Internal Helpers
# ------------------------------

# Initialize directories
#
# Function: _acpi-init-dirs
# Description: Create required XDG-compliant directories
# Internal use only
#
_acpi-init-dirs() {
    mkdir -p "$ACPI_CACHE_DIR" 2>/dev/null || true
    mkdir -p "$ACPI_STATE_DIR" 2>/dev/null || true
    mkdir -p "$ACPI_CONFIG_DIR" 2>/dev/null || true
}

# Emit an event (uses _events if available)
#
# Function: _acpi-emit
# Description: Emit event to event system if available
# Parameters:
#   $1+ - Event name and data
# Internal use only
#
_acpi-emit() {
    [[ "$ACPI_EMIT_EVENTS" != "true" ]] && return 0
    [[ "$ACPI_EVENTS_AVAILABLE" != "true" ]] && return 0

    events-emit "$@"
}

# Parse ACPI event line
#
# Function: _acpi-parse-event
# Description: Parse and route ACPI event from socket
# Parameters:
#   $1 - device
#   $2 - class
#   $3 - id
#   $4 - value
# Internal use only
#
_acpi-parse-event() {
    local device="$1"
    local class="$2"
    local id="$3"
    local value="$4"

    log-trace "ACPI event" "device=$device" "class=$class" "id=$id" "value=$value"

    # Emit raw event
    _acpi-emit "$ACPI_EVENT_RAW" "$device" "$class" "$id" "$value"

    # Parse specific event types
    case "$device" in
        battery|BAT*)
            _acpi-emit "$ACPI_EVENT_BATTERY" "$class" "$id" "$value"
            _acpi-handle-battery-event "$class" "$id" "$value"
            ;;
        ac_adapter|AC*|ACAD)
            _acpi-emit "$ACPI_EVENT_AC" "$class" "$id" "$value"
            _acpi-handle-ac-event "$class" "$id" "$value"
            ;;
        thermal_zone|THRM)
            _acpi-emit "$ACPI_EVENT_THERMAL" "$class" "$id" "$value"
            _acpi-handle-thermal-event "$class" "$id" "$value"
            ;;
        button/lid|LID*)
            _acpi-emit "$ACPI_EVENT_LID" "$class" "$id" "$value"
            _acpi-handle-lid-event "$class" "$id" "$value"
            ;;
        button/*)
            _acpi-emit "$ACPI_EVENT_BUTTON" "$class" "$id" "$value"
            ;;
    esac

    # Execute registered callbacks
    _acpi-execute-callbacks "$device" "$class" "$id" "$value"
}

# Execute registered callbacks for an event
#
# Function: _acpi-execute-callbacks
# Description: Run all matching callbacks for event pattern
# Parameters:
#   $1 - device
#   $2 - class
#   $3 - id
#   $4 - value
# Internal use only
#
_acpi-execute-callbacks() {
    local device="$1"
    local class="$2"
    local id="$3"
    local value="$4"

    local event_string="${device} ${class} ${id} ${value}"

    for pattern in "${(@k)_ACPI_EVENT_CALLBACKS}"; do
        if [[ "$event_string" == ${~pattern} ]]; then
            local callback="${_ACPI_EVENT_CALLBACKS[$pattern]}"
            log-debug "Executing callback" "callback=$callback" "pattern=$pattern"

            if typeset -f "$callback" >/dev/null 2>&1; then
                "$callback" "$device" "$class" "$id" "$value" || {
                    log-error "Callback failed" "callback=$callback"
                }
            else
                log-error "Callback function not found" "callback=$callback"
            fi
        fi
    done
}

# Handle battery events
#
# Function: _acpi-handle-battery-event
# Description: Process battery-specific events and emit threshold alerts
# Parameters:
#   $1 - class
#   $2 - id
#   $3 - value
# Internal use only
#
_acpi-handle-battery-event() {
    local class="$1"
    local id="$2"
    local value="$3"

    # Invalidate battery cache
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-clear-namespace "acpi:battery"
    fi

    # Get current battery status
    local battery_info
    battery_info=$(acpi-battery-status 2>/dev/null)

    if [[ -n "$battery_info" ]]; then
        local capacity=$(echo "$battery_info" | grep -oP '\d+(?=%)')

        if [[ -n "$capacity" ]]; then
            # Check thresholds
            if (( capacity <= ACPI_BATTERY_CRITICAL_THRESHOLD )); then
                _acpi-emit "$ACPI_EVENT_CRITICAL_BATTERY" "capacity=$capacity"
                log-warn "Critical battery level" "capacity=${capacity}%"
            elif (( capacity <= ACPI_BATTERY_LOW_THRESHOLD )); then
                _acpi-emit "$ACPI_EVENT_LOW_BATTERY" "capacity=$capacity"
                log-info "Low battery level" "capacity=${capacity}%"
            fi

            # Emit battery change event
            _acpi-emit "$ACPI_EVENT_BATTERY_CHANGE" "capacity=$capacity" "class=$class"
        fi
    fi
}

# Handle AC adapter events
#
# Function: _acpi-handle-ac-event
# Description: Process AC adapter events (connect/disconnect)
# Parameters:
#   $1 - class
#   $2 - id
#   $3 - value (typically 0=disconnect, 1=connect)
# Internal use only
#
_acpi-handle-ac-event() {
    local class="$1"
    local id="$2"
    local value="$3"

    # Invalidate AC cache
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-clear-namespace "acpi:ac"
    fi

    # Emit specific connect/disconnect events
    case "$value" in
        0|*disconnect*|*off*)
            _acpi-emit "$ACPI_EVENT_AC_DISCONNECT" "class=$class" "id=$id"
            log-info "AC adapter disconnected"
            ;;
        1|*connect*|*on*)
            _acpi-emit "$ACPI_EVENT_AC_CONNECT" "class=$class" "id=$id"
            log-info "AC adapter connected"
            ;;
    esac
}

# Handle thermal events
#
# Function: _acpi-handle-thermal-event
# Description: Process thermal zone events and emit warnings
# Parameters:
#   $1 - class
#   $2 - id
#   $3 - value
# Internal use only
#
_acpi-handle-thermal-event() {
    local class="$1"
    local id="$2"
    local value="$3"

    # Invalidate thermal cache
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-clear-namespace "acpi:thermal"
    fi

    # Get current thermal status
    local temp
    temp=$(acpi-thermal-temp "thermal_zone${id}" 2>/dev/null | grep -oP '\d+ m°C' | awk '{print $1}')

    if [[ -n "$temp" ]]; then
        # Check thresholds
        if (( temp >= ACPI_THERMAL_CRITICAL_THRESHOLD )); then
            _acpi-emit "$ACPI_EVENT_THERMAL_CRITICAL" "temp=$temp" "zone=$id"
            log-error "Critical temperature" "temp=$temp" "zone=$id"
        elif (( temp >= ACPI_THERMAL_WARNING_THRESHOLD )); then
            _acpi-emit "$ACPI_EVENT_THERMAL_WARNING" "temp=$temp" "zone=$id"
            log-warn "High temperature" "temp=$temp" "zone=$id"
        fi
    fi
}

# Handle lid events
#
# Function: _acpi-handle-lid-event
# Description: Process lid open/close events
# Parameters:
#   $1 - class
#   $2 - id
#   $3 - value
# Internal use only
#
_acpi-handle-lid-event() {
    local class="$1"
    local id="$2"
    local value="$3"

    case "$value" in
        *open*)
            _acpi-emit "$ACPI_EVENT_LID_OPEN" "class=$class" "id=$id"
            log-info "Lid opened"
            ;;
        *close*)
            _acpi-emit "$ACPI_EVENT_LID_CLOSE" "class=$class" "id=$id"
            log-info "Lid closed"
            ;;
    esac
}

# ------------------------------
# Initialization
# ------------------------------

# Initialize ACPI extension
#
# Function: acpi-init
# Description: Initialize ACPI extension with infrastructure integration
# Returns:
#   0 - Success
#   1 - Initialization failed
# Example:
#   acpi-init || exit 1
#
acpi-init() {
    [[ "$_ACPI_INITIALIZED" == "true" ]] && return 0

    log-debug "Initializing _acpi v$ACPI_VERSION"

    # Create directories
    _acpi-init-dirs

    # Load configuration if available
    if [[ "$ACPI_CONFIG_AVAILABLE" == "true" ]]; then
        local config_file="${ACPI_CONFIG_DIR}/config.json"
        if [[ -f "$config_file" ]]; then
            config-load "$config_file" 2>/dev/null || true

            # Override defaults with config values
            ACPI_BATTERY_LOW_THRESHOLD=$(config-get "thresholds.battery.low" "$ACPI_BATTERY_LOW_THRESHOLD")
            ACPI_BATTERY_CRITICAL_THRESHOLD=$(config-get "thresholds.battery.critical" "$ACPI_BATTERY_CRITICAL_THRESHOLD")
            ACPI_THERMAL_WARNING_THRESHOLD=$(config-get "thresholds.thermal.warning" "$ACPI_THERMAL_WARNING_THRESHOLD")
            ACPI_THERMAL_CRITICAL_THRESHOLD=$(config-get "thresholds.thermal.critical" "$ACPI_THERMAL_CRITICAL_THRESHOLD")
        fi
    fi

    _ACPI_INITIALIZED="true"
    log-trace "ACPI extension initialized"

    return 0
}

# ------------------------------
# Availability and Configuration
# ------------------------------

# Check if ACPI is available
#
# Function: acpi-check-available
# Description: Verify ACPI daemon and netcat are accessible
# Returns:
#   0 - ACPI is available
#   1 - ACPI not available
# Example:
#   acpi-check-available || echo "ACPI not available"
#
acpi-check-available() {
    # Check if netcat is available
    if ! common-command-exists nc; then
        log-error "netcat not found - required for ACPI socket communication"
        log-info "Install with: sudo pacman -S gnu-netcat"
        return 1
    fi

    # Check if ACPI socket exists
    if [[ ! -S "$ACPI_SOCKET" ]]; then
        log-error "ACPI socket not found" "path=$ACPI_SOCKET"
        log-info "Is acpid running? Try: systemctl status acpid"
        return 1
    fi

    return 0
}

# Require ACPI to be available (exit if not)
#
# Function: acpi-require-available
# Description: Exit script if ACPI is not available
# Example:
#   acpi-require-available  # Script exits if ACPI not running
#
acpi-require-available() {
    acpi-check-available || exit 1
}

# Get ACPI socket path
#
# Function: acpi-get-socket
# Description: Return configured ACPI socket path
# Output: Socket path string
# Example:
#   socket=$(acpi-get-socket)
#
acpi-get-socket() {
    echo "$ACPI_SOCKET"
}

# Get ACPI sysfs path
#
# Function: acpi-get-sysfs-path
# Description: Return sysfs path for ACPI devices
# Output: Sysfs path string
# Example:
#   sysfs=$(acpi-get-sysfs-path)
#
acpi-get-sysfs-path() {
    echo "$ACPI_SYSFS_PATH"
}

# ------------------------------
# Event Listening
# ------------------------------

# Start ACPI event listener
#
# Function: acpi-listen-start
# Description: Start ACPI event listener (blocking or background)
# Parameters:
#   --background - Run in background
# Returns:
#   0 - Success
#   1 - Already running or failed
# Example:
#   acpi-listen-start --background
#
acpi-listen-start() {
    # Lazy initialization
    [[ "$_ACPI_INITIALIZED" == "false" ]] && acpi-init

    if [[ "$ACPI_LISTENER_ACTIVE" == "true" ]]; then
        log-warn "ACPI listener already running" "pid=$ACPI_LISTENER_PID"
        return 1
    fi

    # Check dependencies
    common-command-exists nc || {
        log-error "nc command not found"
        return 1
    }

    if [[ ! -S "$ACPI_SOCKET" ]]; then
        log-error "ACPI socket not found" "path=$ACPI_SOCKET"
        log-error "Is acpid running? Try: systemctl status acpid"
        return 1
    fi

    local background="false"
    if [[ "$1" == "--background" ]]; then
        background="true"
    fi

    log-info "Starting ACPI event listener" "socket=$ACPI_SOCKET"

    if [[ "$background" == "true" ]]; then
        (acpi-listen) &
        ACPI_LISTENER_PID=$!
        ACPI_LISTENER_ACTIVE="true"

        # Track with lifecycle if available
        if [[ "$ACPI_LIFECYCLE_AVAILABLE" == "true" ]]; then
            lifecycle-track-job $ACPI_LISTENER_PID
        fi

        log-info "ACPI listener started in background" "pid=$ACPI_LISTENER_PID"
    else
        acpi-listen
    fi
}

# Listen to ACPI events (blocking)
#
# Function: acpi-listen
# Description: Connect to ACPI socket and process events continuously
# Returns:
#   0 - Normal exit
#   1 - Connection failed
# Example:
#   acpi-listen  # Runs until interrupted
#
acpi-listen() {
    log-trace "Connecting to ACPI socket" "path=$ACPI_SOCKET"

    nc -U "$ACPI_SOCKET" 2>/dev/null | while read -r line; do
        # Parse the event line
        local -a event_parts
        event_parts=(${(z)line})

        if [[ ${#event_parts[@]} -ge 4 ]]; then
            _acpi-parse-event "${event_parts[1]}" "${event_parts[2]}" "${event_parts[3]}" "${event_parts[4]}"
        else
            log-debug "Unparseable ACPI event" "line=$line"
        fi
    done

    local exit_code=$?
    if [[ $exit_code -ne 0 ]]; then
        log-error "ACPI listener connection failed" "exit_code=$exit_code"
        return 1
    fi

    return 0
}

# Stop ACPI event listener
#
# Function: acpi-listen-stop
# Description: Stop running ACPI event listener
# Returns:
#   0 - Success
#   1 - Not running
# Example:
#   acpi-listen-stop
#
acpi-listen-stop() {
    if [[ "$ACPI_LISTENER_ACTIVE" != "true" ]]; then
        log-warn "ACPI listener not running"
        return 1
    fi

    if [[ -n "$ACPI_LISTENER_PID" ]] && kill -0 "$ACPI_LISTENER_PID" 2>/dev/null; then
        log-info "Stopping ACPI listener" "pid=$ACPI_LISTENER_PID"
        kill "$ACPI_LISTENER_PID" 2>/dev/null || true
        wait "$ACPI_LISTENER_PID" 2>/dev/null || true
    fi

    ACPI_LISTENER_PID=""
    ACPI_LISTENER_ACTIVE="false"
    log-info "ACPI listener stopped"
}

# Check listener status
#
# Function: acpi-listen-status
# Description: Check if ACPI listener is running
# Returns:
#   0 - Running
#   1 - Not running
# Output: Status message
# Example:
#   acpi-listen-status
#
acpi-listen-status() {
    if [[ "$ACPI_LISTENER_ACTIVE" == "true" ]] && [[ -n "$ACPI_LISTENER_PID" ]]; then
        if kill -0 "$ACPI_LISTENER_PID" 2>/dev/null; then
            echo "ACPI listener is running (PID: $ACPI_LISTENER_PID)"
            return 0
        else
            echo "ACPI listener is not running (stale PID: $ACPI_LISTENER_PID)"
            ACPI_LISTENER_ACTIVE="false"
            ACPI_LISTENER_PID=""
            return 1
        fi
    else
        echo "ACPI listener is not running"
        return 1
    fi
}

# ------------------------------
# Event Callbacks
# ------------------------------

# Register a callback for ACPI events
#
# Function: acpi-on
# Description: Register callback function for event pattern
# Parameters:
#   $1 - pattern - Event pattern (supports wildcards)
#   $2 - callback - Callback function name
# Returns:
#   0 - Success
#   1 - Callback function not found
#   2 - Invalid arguments
# Example:
#   acpi-on "battery * * *" handle_battery_event
#
acpi-on() {
    local pattern="$1"
    local callback="$2"

    # Validation
    common-validate-required "$pattern" "event pattern" || return 2
    common-validate-required "$callback" "callback function" || return 2

    # Check if callback function exists
    if ! typeset -f "$callback" >/dev/null 2>&1; then
        log-error "Callback function not found" "callback=$callback"
        return 1
    fi

    _ACPI_EVENT_CALLBACKS[$pattern]="$callback"
    log-debug "Registered callback" "callback=$callback" "pattern=$pattern"

    return 0
}

# Unregister a callback
#
# Function: acpi-off
# Description: Remove registered callback for event pattern
# Parameters:
#   $1 - pattern - Event pattern to unregister
# Returns:
#   0 - Success
#   1 - Pattern not found
#   2 - Invalid arguments
# Example:
#   acpi-off "battery * * *"
#
acpi-off() {
    local pattern="$1"

    common-validate-required "$pattern" "event pattern" || return 2

    if [[ -n "${_ACPI_EVENT_CALLBACKS[$pattern]}" ]]; then
        unset "_ACPI_EVENT_CALLBACKS[$pattern]"
        log-debug "Unregistered callback" "pattern=$pattern"
        return 0
    else
        log-warn "No callback registered" "pattern=$pattern"
        return 1
    fi
}

# List registered callbacks
#
# Function: acpi-list-callbacks
# Description: Display all registered event callbacks
# Output: Formatted table of patterns and callbacks
# Example:
#   acpi-list-callbacks
#
acpi-list-callbacks() {
    if [[ ${#_ACPI_EVENT_CALLBACKS[@]} -eq 0 ]]; then
        echo "No callbacks registered"
        return 0
    fi

    printf "%-50s %-30s\n" "Pattern" "Callback"
    printf "%-50s %-30s\n" "-------" "--------"

    for pattern in "${(@k)_ACPI_EVENT_CALLBACKS}"; do
        printf "%-50s %-30s\n" "$pattern" "${_ACPI_EVENT_CALLBACKS[$pattern]}"
    done
}

# ------------------------------
# Battery Status
# ------------------------------

# Get battery status
#
# Function: acpi-battery-status
# Description: Get detailed battery information
# Parameters:
#   $1 - battery - Battery ID (default: BAT0)
# Returns:
#   0 - Success
#   1 - Battery not found
#   2 - Invalid arguments
# Output: Formatted battery status
# Example:
#   acpi-battery-status BAT0
#
acpi-battery-status() {
    local battery="${1:-BAT0}"
    local battery_path="${ACPI_SYSFS_PATH}/power_supply/${battery}"

    # Lazy initialization
    [[ "$_ACPI_INITIALIZED" == "false" ]] && acpi-init

    # Check cache first
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        local cached=$(cache-get "acpi:battery:status:${battery}")
        if [[ -n "$cached" ]]; then
            log-trace "Battery status from cache" "battery=$battery"
            echo "$cached"
            return 0
        fi
    fi

    # Validate battery exists
    if [[ ! -d "$battery_path" ]]; then
        log-error "Battery not found" "battery=$battery" "path=$battery_path"
        return 1
    fi

    local status capacity energy_now energy_full power_now
    local output=""

    # Read battery attributes
    [[ -f "$battery_path/status" ]] && status=$(cat "$battery_path/status")
    [[ -f "$battery_path/capacity" ]] && capacity=$(cat "$battery_path/capacity")
    [[ -f "$battery_path/energy_now" ]] && energy_now=$(cat "$battery_path/energy_now")
    [[ -f "$battery_path/energy_full" ]] && energy_full=$(cat "$battery_path/energy_full")
    [[ -f "$battery_path/power_now" ]] && power_now=$(cat "$battery_path/power_now")

    # Store in state tracking
    _ACPI_BATTERY_STATUS[$battery]="${status}:${capacity}:${energy_now}:${energy_full}:${power_now}"

    # Format output
    output+="Battery: $battery\n"
    output+="Status: ${status:-Unknown}\n"
    output+="Capacity: ${capacity:-?}%"

    if [[ -n "$energy_now" ]] && [[ -n "$energy_full" ]] && [[ "$energy_full" -gt 0 ]]; then
        local energy_pct=$(( energy_now * 100 / energy_full ))
        output+="\nEnergy: ${energy_now} / ${energy_full} µWh (${energy_pct}%)"
    fi

    if [[ -n "$power_now" ]] && [[ "$power_now" -gt 0 ]]; then
        output+="\nPower: ${power_now} µW"

        if [[ -n "$energy_now" ]]; then
            local remaining_hours=$(( energy_now / power_now ))
            output+="\nRemaining: ~${remaining_hours}h"
        fi
    fi

    # Cache result
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-set "acpi:battery:status:${battery}" "$output" "$ACPI_CACHE_BATTERY_TTL"
    fi

    echo "$output"
    return 0
}

# List all batteries
#
# Function: acpi-battery-list
# Description: List all available batteries
# Returns:
#   0 - Success
#   1 - No batteries found
# Output: List of battery IDs
# Example:
#   acpi-battery-list
#
acpi-battery-list() {
    local power_supply_path="${ACPI_SYSFS_PATH}/power_supply"

    if [[ ! -d "$power_supply_path" ]]; then
        log-error "Power supply path not found" "path=$power_supply_path"
        return 1
    fi

    local -a batteries=()
    for bat in "$power_supply_path"/BAT*; do
        if [[ -d "$bat" ]]; then
            batteries+=($(basename "$bat"))
        fi
    done

    if [[ ${#batteries[@]} -eq 0 ]]; then
        echo "No batteries found"
        return 1
    fi

    for bat in "${batteries[@]}"; do
        echo "- $bat"
    done

    return 0
}

# Get battery percentage
#
# Function: acpi-battery-percent
# Description: Get battery charge percentage
# Parameters:
#   $1 - battery - Battery ID (default: BAT0)
# Returns:
#   0 - Success
#   1 - Battery not found or no capacity info
# Output: Battery percentage (number only)
# Example:
#   percent=$(acpi-battery-percent BAT0)
#
acpi-battery-percent() {
    local battery="${1:-BAT0}"
    local battery_path="${ACPI_SYSFS_PATH}/power_supply/${battery}"

    # Check cache first
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        local cached=$(cache-get "acpi:battery:percent:${battery}")
        if [[ -n "$cached" ]]; then
            echo "$cached"
            return 0
        fi
    fi

    if [[ ! -f "$battery_path/capacity" ]]; then
        return 1
    fi

    local capacity=$(cat "$battery_path/capacity")

    # Cache result
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-set "acpi:battery:percent:${battery}" "$capacity" "$ACPI_CACHE_BATTERY_TTL"
    fi

    echo "$capacity"
    return 0
}

# Check if battery is low
#
# Function: acpi-battery-is-low
# Description: Check if battery is below low threshold
# Parameters:
#   $1 - battery - Battery ID (default: BAT0)
# Returns:
#   0 - Battery is low
#   1 - Battery is not low or not found
# Example:
#   acpi-battery-is-low && notify "Battery low"
#
acpi-battery-is-low() {
    local battery="${1:-BAT0}"
    local capacity

    capacity=$(acpi-battery-percent "$battery") || return 1

    if (( capacity <= ACPI_BATTERY_LOW_THRESHOLD )); then
        return 0
    fi

    return 1
}

# Check if battery is critical
#
# Function: acpi-battery-is-critical
# Description: Check if battery is below critical threshold
# Parameters:
#   $1 - battery - Battery ID (default: BAT0)
# Returns:
#   0 - Battery is critical
#   1 - Battery is not critical or not found
# Example:
#   acpi-battery-is-critical && hibernate
#
acpi-battery-is-critical() {
    local battery="${1:-BAT0}"
    local capacity

    capacity=$(acpi-battery-percent "$battery") || return 1

    if (( capacity <= ACPI_BATTERY_CRITICAL_THRESHOLD )); then
        return 0
    fi

    return 1
}

# Get battery charging status
#
# Function: acpi-battery-is-charging
# Description: Check if battery is currently charging
# Parameters:
#   $1 - battery - Battery ID (default: BAT0)
# Returns:
#   0 - Battery is charging
#   1 - Battery is not charging or not found
# Example:
#   acpi-battery-is-charging && echo "Charging"
#
acpi-battery-is-charging() {
    local battery="${1:-BAT0}"
    local battery_path="${ACPI_SYSFS_PATH}/power_supply/${battery}"

    if [[ ! -f "$battery_path/status" ]]; then
        return 1
    fi

    local status=$(cat "$battery_path/status")
    [[ "$status" == "Charging" ]]
}

# Get battery discharging status
#
# Function: acpi-battery-is-discharging
# Description: Check if battery is currently discharging
# Parameters:
#   $1 - battery - Battery ID (default: BAT0)
# Returns:
#   0 - Battery is discharging
#   1 - Battery is not discharging or not found
# Example:
#   acpi-battery-is-discharging && echo "On battery power"
#
acpi-battery-is-discharging() {
    local battery="${1:-BAT0}"
    local battery_path="${ACPI_SYSFS_PATH}/power_supply/${battery}"

    if [[ ! -f "$battery_path/status" ]]; then
        return 1
    fi

    local status=$(cat "$battery_path/status")
    [[ "$status" == "Discharging" ]]
}

# ------------------------------
# AC Adapter Status
# ------------------------------

# Get AC adapter status
#
# Function: acpi-ac-status
# Description: Get AC adapter connection status
# Parameters:
#   $1 - adapter - Adapter ID (default: AC0, auto-detected)
# Returns:
#   0 - Success
#   1 - AC adapter not found
# Output: Formatted AC adapter status
# Example:
#   acpi-ac-status
#
acpi-ac-status() {
    local adapter="${1:-AC0}"
    local adapter_path="${ACPI_SYSFS_PATH}/power_supply/${adapter}"

    # Lazy initialization
    [[ "$_ACPI_INITIALIZED" == "false" ]] && acpi-init

    # Check cache first
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        local cached=$(cache-get "acpi:ac:status:${adapter}")
        if [[ -n "$cached" ]]; then
            log-trace "AC status from cache" "adapter=$adapter"
            echo "$cached"
            return 0
        fi
    fi

    # Try common adapter names if default not found
    if [[ ! -d "$adapter_path" ]]; then
        for alt in AC ACAD ADP0 ADP1; do
            adapter_path="${ACPI_SYSFS_PATH}/power_supply/${alt}"
            if [[ -d "$adapter_path" ]]; then
                adapter="$alt"
                break
            fi
        done
    fi

    if [[ ! -d "$adapter_path" ]]; then
        log-error "AC adapter not found"
        return 1
    fi

    local online
    [[ -f "$adapter_path/online" ]] && online=$(cat "$adapter_path/online")

    local output=""
    output+="AC Adapter: $adapter\n"

    if [[ "$online" == "1" ]]; then
        output+="Status: Connected"
    else
        output+="Status: Disconnected"
    fi

    # Store in state tracking
    _ACPI_AC_STATUS[$adapter]="$online"

    # Cache result
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-set "acpi:ac:status:${adapter}" "$output" "$ACPI_CACHE_AC_TTL"
    fi

    echo "$output"
    return 0
}

# Check if AC is connected
#
# Function: acpi-ac-is-online
# Description: Check if AC adapter is connected
# Parameters:
#   $1 - adapter - Adapter ID (default: AC0, auto-detected)
# Returns:
#   0 - AC is online
#   1 - AC is offline or not found
# Example:
#   acpi-ac-is-online && echo "AC connected"
#
acpi-ac-is-online() {
    local adapter="${1:-AC0}"
    local adapter_path="${ACPI_SYSFS_PATH}/power_supply/${adapter}"

    # Check cache first
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        local cached=$(cache-get "acpi:ac:online:${adapter}")
        if [[ -n "$cached" ]]; then
            [[ "$cached" == "1" ]]
            return $?
        fi
    fi

    # Try common adapter names
    if [[ ! -d "$adapter_path" ]]; then
        for alt in AC ACAD ADP0 ADP1; do
            adapter_path="${ACPI_SYSFS_PATH}/power_supply/${alt}"
            [[ -d "$adapter_path" ]] && break
        done
    fi

    if [[ ! -f "$adapter_path/online" ]]; then
        return 1
    fi

    local online
    online=$(cat "$adapter_path/online")

    # Cache result
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-set "acpi:ac:online:${adapter}" "$online" "$ACPI_CACHE_AC_TTL"
    fi

    [[ "$online" == "1" ]]
}

# ------------------------------
# Thermal Zones
# ------------------------------

# Get thermal zone temperature
#
# Function: acpi-thermal-temp
# Description: Get thermal zone temperature
# Parameters:
#   $1 - zone - Thermal zone ID (default: thermal_zone0)
# Returns:
#   0 - Success
#   1 - Thermal zone not found
#   2 - Invalid arguments
# Output: Temperature in human-readable format
# Example:
#   acpi-thermal-temp thermal_zone0
#
acpi-thermal-temp() {
    local zone="${1:-thermal_zone0}"
    local thermal_path="${ACPI_SYSFS_PATH}/thermal/${zone}"

    # Lazy initialization
    [[ "$_ACPI_INITIALIZED" == "false" ]] && acpi-init

    # Check cache first
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        local cached=$(cache-get "acpi:thermal:temp:${zone}")
        if [[ -n "$cached" ]]; then
            log-trace "Thermal temp from cache" "zone=$zone"
            echo "$cached"
            return 0
        fi
    fi

    if [[ ! -d "$thermal_path" ]]; then
        log-error "Thermal zone not found" "zone=$zone" "path=$thermal_path"
        return 1
    fi

    local temp
    [[ -f "$thermal_path/temp" ]] && temp=$(cat "$thermal_path/temp")

    if [[ -z "$temp" ]]; then
        echo "Temperature unavailable"
        return 1
    fi

    # Temperature is in millidegrees Celsius
    local temp_c=$(( temp / 1000 ))
    local output="${temp_c}°C (${temp} m°C)"

    # Store in state tracking
    _ACPI_THERMAL_STATUS[$zone]="$temp"

    # Cache result
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-set "acpi:thermal:temp:${zone}" "$output" "$ACPI_CACHE_THERMAL_TTL"
    fi

    echo "$output"
    return 0
}

# List all thermal zones
#
# Function: acpi-thermal-list
# Description: List all thermal zones with temperatures
# Returns:
#   0 - Success
#   1 - No thermal zones found
# Output: List of thermal zones and temperatures
# Example:
#   acpi-thermal-list
#
acpi-thermal-list() {
    local thermal_path="${ACPI_SYSFS_PATH}/thermal"

    if [[ ! -d "$thermal_path" ]]; then
        log-error "Thermal path not found" "path=$thermal_path"
        return 1
    fi

    local -a zones=()
    for zone in "$thermal_path"/thermal_zone*; do
        if [[ -d "$zone" ]]; then
            zones+=($(basename "$zone"))
        fi
    done

    if [[ ${#zones[@]} -eq 0 ]]; then
        echo "No thermal zones found"
        return 1
    fi

    for zone in "${zones[@]}"; do
        local temp_str
        temp_str=$(acpi-thermal-temp "$zone" 2>/dev/null || echo "N/A")
        echo "- $zone: $temp_str"
    done

    return 0
}

# Check if thermal zone is over threshold
#
# Function: acpi-thermal-is-hot
# Description: Check if thermal zone exceeds temperature threshold
# Parameters:
#   $1 - zone - Thermal zone ID (default: thermal_zone0)
#   $2 - threshold - Temperature threshold in millidegrees (default: ACPI_THERMAL_WARNING_THRESHOLD)
# Returns:
#   0 - Temperature exceeds threshold
#   1 - Temperature below threshold or zone not found
# Example:
#   acpi-thermal-is-hot thermal_zone0 85000 && echo "Too hot"
#
acpi-thermal-is-hot() {
    local zone="${1:-thermal_zone0}"
    local threshold="${2:-$ACPI_THERMAL_WARNING_THRESHOLD}"
    local thermal_path="${ACPI_SYSFS_PATH}/thermal/${zone}"

    # Validation
    common-validate-numeric "$threshold" || {
        log-error "Threshold must be numeric" "threshold=$threshold"
        return 2
    }

    if [[ ! -f "$thermal_path/temp" ]]; then
        return 1
    fi

    local temp
    temp=$(cat "$thermal_path/temp")

    if (( temp >= threshold )); then
        return 0
    fi

    return 1
}

# Check if thermal zone is critical
#
# Function: acpi-thermal-is-critical
# Description: Check if thermal zone exceeds critical threshold
# Parameters:
#   $1 - zone - Thermal zone ID (default: thermal_zone0)
# Returns:
#   0 - Temperature is critical
#   1 - Temperature not critical or zone not found
# Example:
#   acpi-thermal-is-critical && shutdown now
#
acpi-thermal-is-critical() {
    local zone="${1:-thermal_zone0}"
    acpi-thermal-is-hot "$zone" "$ACPI_THERMAL_CRITICAL_THRESHOLD"
}

# ------------------------------
# Power State
# ------------------------------

# Get overall power status
#
# Function: acpi-power-status
# Description: Get comprehensive power status (AC, batteries, thermal)
# Output: Formatted power status report
# Example:
#   acpi-power-status
#
acpi-power-status() {
    echo "=== Power Status ==="
    echo ""

    # AC adapter
    acpi-ac-status 2>/dev/null || echo "AC adapter: Unknown"
    echo ""

    # Batteries
    local -a batteries=(${(f)"$(acpi-battery-list 2>/dev/null)"})
    if [[ ${#batteries[@]} -gt 0 ]]; then
        for bat_line in "${batteries[@]}"; do
            local bat=$(echo "$bat_line" | sed 's/^- //')
            acpi-battery-status "$bat" 2>/dev/null || echo "Battery $bat: Unknown"
            echo ""
        done
    else
        echo "No batteries found"
        echo ""
    fi

    # Thermal zones
    local -a zones=(${(f)"$(acpi-thermal-list 2>/dev/null)"})
    if [[ ${#zones[@]} -gt 0 ]]; then
        echo "=== Thermal Status ==="
        for zone_line in "${zones[@]}"; do
            echo "$zone_line"
        done
    fi
}

# Get system power profile
#
# Function: acpi-power-profile
# Description: Determine system power profile based on AC and battery status
# Returns:
#   0 - Success
# Output: Power profile (performance, balanced, powersave, powersave-critical)
# Example:
#   profile=$(acpi-power-profile)
#
acpi-power-profile() {
    local ac_online="false"
    acpi-ac-is-online && ac_online="true"

    local battery_low="false"
    acpi-battery-is-low && battery_low="true"

    local battery_critical="false"
    acpi-battery-is-critical && battery_critical="true"

    if [[ "$ac_online" == "true" ]]; then
        echo "performance"
    elif [[ "$battery_critical" == "true" ]]; then
        echo "powersave-critical"
    elif [[ "$battery_low" == "true" ]]; then
        echo "powersave"
    else
        echo "balanced"
    fi
}

# ------------------------------
# Monitoring
# ------------------------------

# Monitor battery continuously
#
# Function: acpi-monitor-battery
# Description: Continuously monitor battery status
# Parameters:
#   $1 - interval - Update interval in seconds (default: 5)
# Returns:
#   0 - Normal exit (interrupted)
# Example:
#   acpi-monitor-battery 3
#
acpi-monitor-battery() {
    local interval="${1:-5}"

    # Validation
    common-validate-numeric "$interval" || {
        log-error "Interval must be numeric" "interval=$interval"
        return 2
    }

    log-info "Monitoring battery" "interval=${interval}s" "press Ctrl+C to stop"

    while true; do
        clear
        acpi-battery-status
        sleep "$interval"
    done
}

# Monitor thermal zones continuously
#
# Function: acpi-monitor-thermal
# Description: Continuously monitor thermal zones
# Parameters:
#   $1 - interval - Update interval in seconds (default: 2)
# Returns:
#   0 - Normal exit (interrupted)
# Example:
#   acpi-monitor-thermal 1
#
acpi-monitor-thermal() {
    local interval="${1:-2}"

    # Validation
    common-validate-numeric "$interval" || {
        log-error "Interval must be numeric" "interval=$interval"
        return 2
    }

    log-info "Monitoring thermal zones" "interval=${interval}s" "press Ctrl+C to stop"

    while true; do
        clear
        acpi-thermal-list
        sleep "$interval"
    done
}

# Monitor all power status
#
# Function: acpi-monitor-power
# Description: Continuously monitor complete power status
# Parameters:
#   $1 - interval - Update interval in seconds (default: 5)
# Returns:
#   0 - Normal exit (interrupted)
# Example:
#   acpi-monitor-power 10
#
acpi-monitor-power() {
    local interval="${1:-5}"

    # Validation
    common-validate-numeric "$interval" || {
        log-error "Interval must be numeric" "interval=$interval"
        return 2
    }

    log-info "Monitoring power status" "interval=${interval}s" "press Ctrl+C to stop"

    while true; do
        clear
        acpi-power-status
        sleep "$interval"
    done
}

# ------------------------------
# Cleanup
# ------------------------------

# Cleanup function (called automatically via lifecycle)
#
# Function: acpi-cleanup
# Description: Clean up ACPI resources (listeners, callbacks, caches)
# Example:
#   acpi-cleanup  # Usually called automatically on exit
#
acpi-cleanup() {
    log-debug "Cleaning up ACPI extension"

    # Stop listener if running
    if [[ "$ACPI_LISTENER_ACTIVE" == "true" ]]; then
        acpi-listen-stop
    fi

    # Clear callbacks
    _ACPI_EVENT_CALLBACKS=()

    # Clear state tracking
    _ACPI_BATTERY_STATUS=()
    _ACPI_THERMAL_STATUS=()
    _ACPI_AC_STATUS=()

    # Clear caches if available
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        cache-clear-namespace "acpi" 2>/dev/null || true
    fi

    log-trace "ACPI cleanup complete"
}

# ------------------------------
# Utility Functions
# ------------------------------

# Display version
#
# Function: acpi-ext-version
# Description: Display extension version
# Output: Version string
# Example:
#   acpi-ext-version
#
acpi-ext-version() {
    echo "$ACPI_VERSION"
}

# Display help
#
# Function: acpi-help
# Description: Display comprehensive help information
# Example:
#   acpi-help
#
acpi-help() {
    cat <<EOF
_acpi - ACPI Event and Power Management System

Version: $ACPI_VERSION

INTEGRATION STATUS:
  _common:    yes (required)
  _log:       ${LOG_LOADED:-false}
  _events:    ${ACPI_EVENTS_AVAILABLE:-false}
  _cache:     ${ACPI_CACHE_AVAILABLE:-false}
  _lifecycle: ${ACPI_LIFECYCLE_AVAILABLE:-false}
  _config:    ${ACPI_CONFIG_AVAILABLE:-false}

USAGE:
  source "\$(which _acpi)"

INITIALIZATION:
  acpi-init                     Initialize ACPI extension
  acpi-check-available          Check if ACPI is available
  acpi-require-available        Exit if ACPI not available
  acpi-get-socket               Get ACPI socket path
  acpi-get-sysfs-path           Get sysfs path

EVENT LISTENING:
  acpi-listen-start [--background]    Start event listener
  acpi-listen                         Listen to events (blocking)
  acpi-listen-stop                    Stop event listener
  acpi-listen-status                  Check listener status

EVENT CALLBACKS:
  acpi-on PATTERN CALLBACK      Register event callback
  acpi-off PATTERN              Unregister event callback
  acpi-list-callbacks           List registered callbacks

BATTERY STATUS:
  acpi-battery-status [BAT]     Get battery status
  acpi-battery-list             List all batteries
  acpi-battery-percent [BAT]    Get battery percentage
  acpi-battery-is-low [BAT]     Check if battery is low
  acpi-battery-is-critical [BAT]  Check if battery is critical
  acpi-battery-is-charging [BAT]  Check if charging
  acpi-battery-is-discharging [BAT]  Check if discharging

AC ADAPTER:
  acpi-ac-status [AC]           Get AC adapter status
  acpi-ac-is-online [AC]        Check if AC is connected

THERMAL ZONES:
  acpi-thermal-temp [ZONE]      Get thermal zone temperature
  acpi-thermal-list             List all thermal zones
  acpi-thermal-is-hot [ZONE] [THRESHOLD]  Check temperature
  acpi-thermal-is-critical [ZONE]  Check if critical

POWER STATE:
  acpi-power-status             Get overall power status
  acpi-power-profile            Get power profile

MONITORING:
  acpi-monitor-battery [INTERVAL]   Monitor battery
  acpi-monitor-thermal [INTERVAL]   Monitor thermal zones
  acpi-monitor-power [INTERVAL]     Monitor power status

UTILITIES:
  acpi-cleanup                  Clean up resources
  acpi-ext-version              Display version
  acpi-help                     Display this help
  acpi-self-test                Run self-tests

CONFIGURATION:
  ACPI_SOCKET               ACPI socket path
  ACPI_BATTERY_LOW_THRESHOLD      Low battery threshold (%)
  ACPI_BATTERY_CRITICAL_THRESHOLD Critical threshold (%)
  ACPI_THERMAL_WARNING_THRESHOLD  Thermal warning (millidegrees)
  ACPI_THERMAL_CRITICAL_THRESHOLD Thermal critical (millidegrees)
  ACPI_EMIT_EVENTS          Emit events to event system
  ACPI_DEBUG                Enable debug logging

EXAMPLES:
  # Monitor battery
  acpi-monitor-battery 5

  # Check if battery is low
  acpi-battery-is-low && notify "Battery low!"

  # Register callback for battery events
  handle_battery() { echo "Battery event: \$*"; }
  acpi-on "battery * * *" handle_battery
  acpi-listen-start --background

  # Get power profile
  profile=\$(acpi-power-profile)
  echo "Current profile: \$profile"

For detailed documentation: cat ~/.local/docs/lib/_acpi.md
EOF
}

# Self-test
#
# Function: acpi-self-test
# Description: Run comprehensive self-tests
# Returns:
#   0 - All tests passed
#   1 - Some tests failed
# Example:
#   acpi-self-test
#
acpi-self-test() {
    log-info "Running _acpi v$ACPI_VERSION self-test"
    local tests_passed=0
    local tests_failed=0

    # Test 1: Initialization
    if acpi-init 2>/dev/null; then
        log-info "✓ Initialization successful"
        ((tests_passed++))
    else
        log-error "✗ Initialization failed"
        ((tests_failed++))
    fi

    # Test 2: Dependencies
    log-info "Dependency check:"
    log-info "  _common:    yes (required)"
    log-info "  _log:       ${LOG_LOADED:-false}"
    log-info "  _events:    ${ACPI_EVENTS_AVAILABLE:-false}"
    log-info "  _cache:     ${ACPI_CACHE_AVAILABLE:-false}"
    log-info "  _lifecycle: ${ACPI_LIFECYCLE_AVAILABLE:-false}"
    log-info "  _config:    ${ACPI_CONFIG_AVAILABLE:-false}"
    ((tests_passed++))

    # Test 3: System utilities
    log-info "System utilities:"
    if common-command-exists nc; then
        log-info "  nc: Available"
        ((tests_passed++))
    else
        log-error "  nc: Missing (required for event listening)"
        ((tests_failed++))
    fi

    # Test 4: ACPI socket
    log-info "ACPI socket:"
    if [[ -S "$ACPI_SOCKET" ]]; then
        log-info "  $ACPI_SOCKET: Found"
        ((tests_passed++))
    else
        log-warn "  $ACPI_SOCKET: Not found (is acpid running?)"
        ((tests_failed++))
    fi

    # Test 5: Battery detection
    log-info "Battery detection:"
    if acpi-battery-list &>/dev/null; then
        acpi-battery-list 2>/dev/null | while read -r line; do
            log-info "  $line"
        done
        ((tests_passed++))
    else
        log-info "  No batteries found (may be expected on desktop)"
        ((tests_passed++))
    fi

    # Test 6: AC adapter detection
    log-info "AC adapter detection:"
    if acpi-ac-status &>/dev/null; then
        log-info "  AC adapter found"
        ((tests_passed++))
    else
        log-info "  No AC adapter found (may be expected on desktop)"
        ((tests_passed++))
    fi

    # Test 7: Thermal zones
    log-info "Thermal zones:"
    if acpi-thermal-list &>/dev/null; then
        acpi-thermal-list 2>/dev/null | while read -r line; do
            log-info "  $line"
        done
        ((tests_passed++))
    else
        log-info "  No thermal zones found"
        ((tests_passed++))
    fi

    # Test 8: Callback registration
    log-info "Callback registration:"
    test_callback() { :; }
    if acpi-on "test * * *" test_callback 2>/dev/null; then
        log-info "  ✓ Callback registered"
        acpi-off "test * * *" 2>/dev/null
        log-info "  ✓ Callback unregistered"
        ((tests_passed++))
    else
        log-error "  ✗ Callback registration failed"
        ((tests_failed++))
    fi

    # Test 9: Caching integration
    if [[ "$ACPI_CACHE_AVAILABLE" == "true" ]]; then
        log-info "✓ Cache integration available"
        ((tests_passed++))
    else
        log-info "○ Cache integration not available (optional)"
        ((tests_passed++))
    fi

    # Test 10: Event integration
    if [[ "$ACPI_EVENTS_AVAILABLE" == "true" ]]; then
        log-info "✓ Event integration available"
        ((tests_passed++))
    else
        log-info "○ Event integration not available (optional)"
        ((tests_passed++))
    fi

    log-info ""
    log-info "Self-tests complete: $tests_passed passed, $tests_failed failed"

    if [[ $tests_failed -eq 0 ]]; then
        return 0
    else
        return 1
    fi
}

# ------------------------------
# Initialization
# ------------------------------

# Initialize directories on load
_acpi-init-dirs

# Auto-cleanup integration
if [[ "$ACPI_AUTO_CLEANUP" == "true" ]] && [[ "$ACPI_LIFECYCLE_AVAILABLE" == "true" ]]; then
    lifecycle-cleanup acpi-cleanup
fi

# Log module load
log-debug "_acpi extension loaded" "version=$ACPI_VERSION" "integrations=events:$ACPI_EVENTS_AVAILABLE,cache:$ACPI_CACHE_AVAILABLE,lifecycle:$ACPI_LIFECYCLE_AVAILABLE,config:$ACPI_CONFIG_AVAILABLE"
